
@{
    ViewBag.Title = "Đăng ký xét tuyển";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    label {
        white-space: nowrap !important;
    }

    .span_with_for {
        width: 65px !important
    }

    .btn, .form-select, .form-control {
        border-radius: 3px;
    }

    .padding_input_text_number {
        padding-left: 0px !important;
        padding-right: 0px !important;
        text-align: center !important;
    }
</style>
<header class="page-header page-header-compact page-header-light border-bottom bg-white mb-2">
    <div class="container-fluid px-4">
        <div class="page-header-content">
            <div class="row align-items-center justify-content-between pt-3">
                <div class="col-auto mb-1">
                    <div class="page-header-title mb-2">
                        <div class="page-header-icon"><i data-feather="list"></i></div>
                        <span id="sp_tieude"></span>
                        <script>
                            $(document).ready(function () {
                                let sp_tieude = $('#sp_tieude');
                                if (window.innerWidth <= 1200) {
                                    sp_tieude.text('Đăng ký xét tuyển bằng điểm học bạ');
                                    
                                    $('#files_hocba').hide();
                                    $('#files_cancuoc_congdan').hide();
                                    $('#files_bangtn').hide();
                                    $('#files_giayto_uutien').hide();
                                }
                                else {
                                    sp_tieude.text('Đăng ký xét tuyển sử dụng kết quả học tập ở trung học phổ thông (Xét tuyển bằng học bạ)');
                                     
                                    $('#files_hocba').show();
                                    $('#files_cccd').show();
                                    $('#files_bangtn').show();
                                    $('#files_giayto_uutien').show();
                                }

                                function reportWindowSize() {
                                    if (window.innerWidth <= 1200) {
                                        sp_tieude.text('Đăng ký xét tuyển bằng điểm học bạ');
                                        $('#files_hocba').hide();
                                        $('#files_cancuoc_congdan').hide();
                                        $('#files_bangtn').hide();
                                        $('#files_giayto_uutien').hide();
                                    }
                                    else {
                                        sp_tieude.text('Đăng ký xét tuyển sử dụng kết quả học tập ở trung học phổ thông (Xét tuyển bằng học bạ)');

                                        $('#files_hocba').show();
                                        $('#files_cccd').show();
                                        $('#files_bangtn').show();
                                        $('#files_giayto_uutien').show();
                                    }
                                }
                                window.onresize = reportWindowSize;
                            })
                        </script>
                    </div>
                </div>

            </div>
        </div>
    </div>
</header>
<div class="container-fluid px-12">
    <div id="div_update_aspirations">
        <div class="card card-header-actions">
            <div class="card-header">
                <span>Chỉnh sửa nguyện vọng đã đăng ký</span>
                <button class="btn-close" id="bt_close_div_update_aspirations_first" type="button" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 col-md-12">
                        <div class="row table-hover">
                            <div class="col-12"><b>Ngành và tổ hợp môn </b></div>
                            <div class="col-12"><hr class="mt-1 mb-0" /><hr class="mt-0 mb-2" /></div>
                        </div>
                        <div class="row">
                            <div class="col-4">Khối ngành</div>
                            <div class="col-8"><select id="select_khoinganh" class="form-select" disabled></select></div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row">
                            <div class="col-4">Ngành</div>
                            <div class="col-8">
                                <select id="select_nganh" class="form-select" disabled></select>                               
                            </div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row">
                            <div class="col-4">Tổ hợp môn</div>
                            <div class="col-8">
                                <select id="select_tohopmon" class="form-select" disabled></select>                                 
                            </div>
                            <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        </div>
                        <div class="row">
                            <div class="col-6 ">
                                <span id="span_Uutien_doituong"></span>
                                <hr />
                            </div>
                            <div class="col-6  ">
                                <span id="span_Uutien_khuvuc"></span>
                                <hr />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <span> Học lực lớp 12</span>
                                <input id="txt_hocluc_12" type="text" class="form-control" value="" disabled />
                            </div>
                            <div class="col-6">
                                <span>Hạnh kiểm lớp 12</span>
                                <input id="txt_hanhkiem_12" type="text" class="form-control" value="" disabled />
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-12">
                        <div class="row">
                            <div class="col-12"><b>Điểm các môn xét tuyển</b></div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-0" /><hr class="mt-0 mb-2" /></div>
                        <div class="row g-1">
                            <div class="col-3"><span style="visibility:hidden">TenHK</span></div>
                            <div class="col-2">K1/11</div>
                            <div class="col-2">K2/11</div>
                            <div class="col-2">K1/12</div>
                            <div class="col-3">TBC</div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row g-1">
                            <div class="col-3"><label id="lb_tenmon_1" class="form-label">Chưa chọn</label></div>
                            <div class="col-2"><input id="txt_m1_k1" type="number" class="form-control input-mon1 padding_input_text_number " value="" disabled /></div>
                            <div class="col-2"><input id="txt_m1_k2" type="number" class="form-control input-mon1 padding_input_text_number " value="" disabled /></div>
                            <div class="col-2"><input id="txt_m1_k3" type="number" class="form-control input-mon1 padding_input_text_number " value="" disabled /></div>
                            <div class="col-3"><input id="txt_tb_m1" type="text" class="form-control padding_input_text_number input-tong" value="" disabled /></div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row g-1">
                            <div class="col-3"><label id="lb_tenmon_2" class="form-label">Chưa chọn</label></div>
                            <div class="col-2"><input id="txt_m2_k1" type="number" class="form-control input-mon2 padding_input_text_number " value="" disabled /></div>
                            <div class="col-2"><input id="txt_m2_k2" type="number" class="form-control input-mon2 padding_input_text_number " value="" disabled /></div>
                            <div class="col-2"><input id="txt_m2_k3" type="number" class="form-control input-mon2 padding_input_text_number " value="" disabled /></div>
                            <div class="col-3"><input id="txt_tb_m2" type="text" class="form-control padding_input_text_number input-tong" value="" disabled /></div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row g-1">
                            <div class="col-3"><label id="lb_tenmon_3" class="form-label">Chưa chọn</label></div>
                            <div class="col-2"><input id="txt_m3_k1" type="number" class="form-control input-mon3 padding_input_text_number " value="" disabled /></div>
                            <div class="col-2"><input id="txt_m3_k2" type="number" class="form-control input-mon3 padding_input_text_number " value="" disabled /></div>
                            <div class="col-2"><input id="txt_m3_k3" type="number" class="form-control input-mon3 padding_input_text_number " value="" disabled /></div>
                            <div class="col-3"><input id="txt_tb_m3" type="text" class="form-control padding_input_text_number input-tong" value="" disabled /></div>
                        </div>
                        <div class="col-12"> <span id="Diem_All_Error" class="small mb-1 text-danger"></span></div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row">
                            <div class="col-12"><b> Minh chứng học bạ</b></div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-0" /><hr class="mt-0 mb-2" /></div>
                        <div class="row">
                            <div class="col-12">(<span id="sp_view_mc_hocba"></span>)</div>
                            <div class="col-12">
                                <input id="files_hocba" type="file" multiple class="form-control" data-val="true" data-val-required="Vui lòng chọn file học bạ" accept=".pdf,.png, .PNG,.jpeg,.JPEG,.jpg,.JPG" disabled/>                                 
                            </div>                          
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                    </div>

                    <div class="col-lg-4 col-md-12">
                        <div class="row">
                            <div class="col-12"><b>Minh chứng khác</b></div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-0" /><hr class="mt-0 mb-2" /></div>
                        <div class="row">
                            <div class="col-12">Căn cước công dân (<span id="sp_view_mc_cccd"></span>)</div>
                            <div class="col-12">
                                <input class="form-control" id="files_cancuoc_congdan" multiple="multiple" name="files_cancuoc_congdan" type="file" data-val="true" accept=".pdf,.png, .PNG,.jpeg,.JPEG,.jpg,.JPG" disabled/>
                            </div>                             
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row">
                            <div class="col-12">Bằng Tốt nghiệp (<span id="sp_view_mc_bang"></span>)</div>
                            <div class="col-12">
                                <input class="form-control" id="files_bangtn" multiple="multiple" name="files_bangtn" type="file" data-val="true" accept=".pdf,.png, .PNG,.jpeg,.JPEG,.jpg,.JPG" disabled/>
                            </div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                        <div class="row">
                            <div class="col-12">Giấy tờ ưu tiên (<span id="sp_view_mc_uutien"></span>)</div>
                            <div class="col-12">
                                <input class="form-control" id="files_giayto_uutien" multiple="multiple" name="files_giayto_uutien" type="file" data-val="true" accept=".pdf,.png, .PNG,.jpeg,.JPEG,.jpg,.JPG" disabled/>
                            </div>
                        </div>
                        <div class="col-12"><hr class="mt-1 mb-2" /></div>
                    </div>
                </div>

                <div class="row mt-1 mb-3">
                    <div class="col-xxl-12" style="text-align:center">
                        <button class="btn btn-outline-primary" id="bt_ok_div_update_aspirations">Sửa</button>
                        <input type="hidden" id="Dkxt_TrangThai_HoSo_Check" />
                        <button class="btn btn-outline-secondary" id="bt_close_div_update_aspirations_second">Quay lại</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="div_view_img" style="display:none">
        <div class="card card-header-actions">
            <div class="card-header mt-0 mb-0">
                <span id="img_txt_card_hearder">Hình ảnh minh chứng</span>
                <div>              
                    <button class="btn btn-outline-primary btn-sm" type="button" id="bt_close_div_view_img">Đóng</button>
                </div>
            </div>
            <div class="card-body" style="margin: 0px!important">
                <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active" id="div_item_view_minhchung">
                            <img class="d-block w-100 img-hide" id="img_view" display:none">
                            <embed id="pdf_view" class="d-block w-100" style="display:none" type="application/pdf" />
                            <input type="hidden" id="hiden_id_key" style="display:none" />
                            <input type="hidden" id="hiden_loai_minhchung_xoa" style="display:none" />
                            <input type="hidden" id="hiden_duongdan_file_xoa" style="display:none" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" value="@ViewBag.Dkxt_ID" id="hidden_Dkxt_HB_ID" />
<input type="hidden" id="dkxt_hocba_id_checkin" name="dkxt_hocba_id_checkin" />
 
 
<script>
    $(document).ready(function () {
        // hiển thị thông tin đăng ký nguyện vọng
        LoadDataInfor_XTHB_ByID();
        //hiển thị các hình ảnh minh chứng
        LoadImageMC_XTHB_ByID();
         
    })
    function ConvertStringToDate(str) {
        var mdy = str.split('-');
        return new Date(mdy[0], mdy[1], mdy[2]);
    }
    function LoadDataInfor_XTHB_ByID() {
        /*  var hidden_Dkxt_HB_ID = $('#hidden_Dkxt_HB_ID').val();*/
        let data_get = { Dkxt_HB_ID: $('#hidden_Dkxt_HB_ID').val() }
        $.ajax({
            url: "/DangKyXetTuyens/DangKyXetTuyen_HB_GetByID",
            data: JSON.stringify(data_get),
            type: 'POST',
            contentType: 'application/json;charset=utf-8',
            dataType: 'json',
            async: false,
            success: function (res) {
               // console.log("test", res)
                if (res.success) {
                    let data = res.data;
                    console.log(data);
                    $("#select_tohopmon").empty();
                    $("#select_nganh").empty();
                    $('#select_khoinganh').empty();                     
                   
                    $("#select_khoinganh").append($("<option></option>").attr("value", data.KhoiNganh_ID).text(data.KhoiNganh_Ten));                  
                    $('#select_nganh').append('<option value="' + data.Nganh_ID + '">' + data.Nganh_TeNganh + '</option>');
                    $('#select_tohopmon').append('<option value="' + data.Thm_ID + '">' + data.Thm_Ten + '</option>');

                  
                    $('#txt_hocluc_12').val(data.ThiSinh_HocLucLop12);
                    $('#txt_hanhkiem_12').val(data.ThiSinh_HanhKiemLop12);

                    $('#span_Uutien_doituong').text(data.DoiTuong_ID);
                    $('#span_Uutien_khuvuc').text(data.KhuVuc_ID);

                    $('#lb_tenmon_1').text(data.Dkxt_Diem_M1.TenMon);
                    $('#txt_m1_k1').val(data.Dkxt_Diem_M1.HK1);
                    $('#txt_m1_k2').val(data.Dkxt_Diem_M1.HK2);
                    $('#txt_m1_k3').val(data.Dkxt_Diem_M1.HK3);
                    $('#txt_tb_m1').val(data.Dkxt_Diem_M1.DTB);

                    $('#lb_tenmon_2').text(data.Dkxt_Diem_M2.TenMon);
                    $('#txt_m2_k1').val(data.Dkxt_Diem_M2.HK1);
                    $('#txt_m2_k2').val(data.Dkxt_Diem_M2.HK2);
                    $('#txt_m2_k3').val(data.Dkxt_Diem_M2.HK3);
                    $('#txt_tb_m2').val(data.Dkxt_Diem_M2.DTB);

                    $('#lb_tenmon_3').text(data.Dkxt_Diem_M3.TenMon);
                    $('#txt_m3_k1').val(data.Dkxt_Diem_M3.HK1);
                    $('#txt_m3_k2').val(data.Dkxt_Diem_M3.HK2);
                    $('#txt_m3_k3').val(data.Dkxt_Diem_M3.HK3);
                    $('#txt_tb_m3').val(data.Dkxt_Diem_M3.DTB);


                    $('#dkxt_hocba_id_checkin').val(data.Dkxt_HB_ID);
                    $('#Dkxt_TrangThai_HoSo_Check').val(data.Dkxt_HB_TrangThai_HoSo);
                    $('#hiden_CheckSetUpdate').val(data.Dkxt_CheckSetUpdate);  

                    if (data.Dkxt_CheckSetUpdate == 0) {
                        $('#bt_ok_div_update_aspirations').prop('disabled', true);
                        if (data.Dkxt_HB_TrangThai_HoSo == 9) { $('#bt_ok_div_update_aspirations').text('Trường đã duyệt'); }
                        else { $('#bt_ok_div_update_aspirations').text('Đến trang sửa'); }
                    }
                    else if (data.Dkxt_CheckSetUpdate == 1) {
                        if (data.Dkxt_HB_TrangThai_HoSo == 9) {
                            $('#bt_ok_div_update_aspirations').prop('disabled', true);
                            $('#bt_ok_div_update_aspirations').text('Trường đã duyệt');
                        }
                        else {
                            $('#bt_ok_div_update_aspirations').prop('disabled', false);
                            $('#bt_ok_div_update_aspirations').text('Đến trang sửa');
                        }
                    }
                }
            },
            error: function (er) {
                console.log(er.error);
            }
        });

    }
    
    function LoadImageMC_XTHB_ByID() {
        /*  var hidden_Dkxt_HB_ID = $('#hidden_Dkxt_HB_ID').val();*/
        let data_get = { Dkxt_HB_ID: $('#hidden_Dkxt_HB_ID').val() }
        $.ajax({
            url: "/DangKyXetTuyens/DangKyXetTuyen_HB_GetByID",
            data: JSON.stringify(data_get),
            type: 'POST',
            contentType: 'application/json;charset=utf-8',
            dataType: 'json',
            async: false,
            success: function (res) {
                console.log("test", res)
                if (res.success) {
                    let data = res.data;
                    $('#sp_view_mc_hocba').empty();
                    if (data.Dkxt_HB_MinhChung_HB) {
                        const ArrMCHocBa = data.Dkxt_HB_MinhChung_HB.split("#");
                        if (ArrMCHocBa.length > 0) {

                            for (i = 0; i < ArrMCHocBa.length; i++) {
                                if (ArrMCHocBa[i].length > 0) {
                                    var str_a = ` <a style="cursor:pointer;" onclick="showimg('${ArrMCHocBa[i]}',2,${data.Dkxt_HB_ID})" class="link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover">Tệp ${i + 1}</a> `;
                                    $('#sp_view_mc_hocba').append(str_a);
                                }
                            }
                        }
                        else {
                            var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                            $('#sp_view_mc_hocba').append(str_a);
                        }
                    }
                    else {
                        var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                        $('#sp_view_mc_hocba').append(str_a);
                    }

                    $('#sp_view_mc_bang').empty();

                    if (data.Dkxt_HB_MinhChung_Bang) {
                        const ArrMCBang = data.Dkxt_HB_MinhChung_Bang.split("#");
                        if (ArrMCBang.length > 0) {

                            for (i = 0; i < ArrMCBang.length; i++) {
                                if (ArrMCBang[i].length > 0) {
                                    var str_a = ` <a style="cursor:pointer;" onclick="showimg('${ArrMCBang[i]}',3,${data.Dkxt_HB_ID})" class="link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover">Tệp ${i + 1}</a> `;
                                    $('#sp_view_mc_bang').append(str_a);
                                }
                            }
                        }
                        else {
                            var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                            $('#sp_view_mc_bang').append(str_a);
                        }
                    }
                    else {
                        var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                        $('#sp_view_mc_bang').append(str_a);
                    }


                    $('#sp_view_mc_cccd').empty();

                    if (data.Dkxt_HB_MinhChung_CCCD) {
                        const ArrMCCCCD = data.Dkxt_HB_MinhChung_CCCD.split("#");
                        if (ArrMCCCCD.length > 0) {

                            for (i = 0; i < ArrMCCCCD.length; i++) {
                                if (ArrMCCCCD[i].length > 0) {
                                    var str_a = `<a style="cursor:pointer;"  onclick="showimg('${ArrMCCCCD[i]}',4,${data.Dkxt_HB_ID})" class="link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover">Tệp ${i + 1}</a> `;
                                    $('#sp_view_mc_cccd').append(str_a);
                                }
                            }
                        }
                        else {
                            var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                            $('#sp_view_mc_cccd').append(str_a);
                        }

                    }
                    else {
                        var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                        $('#sp_view_mc_cccd').append(str_a);
                    }

                    $('#sp_view_mc_uutien').empty();

                    if (data.Dkxt_HB_MinhChung_UuTien) {
                        const ArrMCUutien = data.Dkxt_HB_MinhChung_UuTien.split("#");
                        if (ArrMCUutien.length > 0) {

                            for (i = 0; i < ArrMCUutien.length; i++) {
                                if (ArrMCUutien[i].length > 0) {
                                    var str_a = ` <a style="cursor:pointer;" onclick="showimg('${ArrMCUutien[i]}',5,${data.Dkxt_HB_ID})" class="link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover">Tệp ${i + 1}</a> `;
                                    $('#sp_view_mc_uutien').append(str_a);
                                }
                            }
                        }
                        else {
                            var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                            $('#sp_view_mc_uutien').append(str_a);
                        }
                    }
                    else {
                        var str_a = ` <a style="color:red">Không có dữ liệu</a> `;
                        $('#sp_view_mc_uutien').append(str_a);
                    }
                }
            },
            error: function (errormessage) {
                console.log(errormessage.error);
            }
        });
    };   
    // phần xử lý dữ liệu cho div update
    $(document).ready(function () {        
        $('input').on('input', function () {
            hideErrorMessage($(this));
        });
        $('select').on('input', function () {
            hideErrorMessage($(this));
        });
        $('#bt_ok_div_update_aspirations').click(function () {
            if ($('#Dkxt_TrangThai_HoSo_Check').val() != 9) {
                var str_query = window.location.search;
                window.location.href = "/DangKyXetTuyens/DkxthocbaEdit" + str_query;
            }
            else {
                alert('Nguyện vọng đã được duyệt, không thể sửa');
                // hiển thị modal thông báo
            }
        });
        // button tắt cửa sổ thêm mới phía trên
        $('#bt_close_div_update_aspirations_first').click(function () {
            window.location.href = '/DangKyXetTuyens/Dkxthocba';
        });
        // button tắt cửa sổ thêm mới phía dưới
        $('#bt_close_div_update_aspirations_second').click(function () {
            window.location.href = '/DangKyXetTuyens/Dkxthocba';
        });
    });     
    
    function hideErrorMessage(input) {
        var errorContainer = input.next('.text-danger');
        errorContainer.text('');
    }   
    
   
</script>
<script>
    function showimg(url, loaimc, id_key_hs) {

        $('#hiden_id_key').val(id_key_hs);
        $('#hiden_loai_minhchung_xoa').val(loaimc);
        $("#hiden_duongdan_file_xoa").val(url);

        var pdf_view = document.getElementById("pdf_view");

        $('#pdf_view').height('0px');
        $('#pdf_view').css('display', 'none');
        $("#pdf_view").attr("src", "");
        $("#pdf_view").hide();

        $("#img_view").attr("src", "");
        $('#img_view').hide();

        if (loaimc == 2) {
            $('#img_txt_card_hearder').text('Minh chứng học bạ');
        }
        if (loaimc == 3) {
            $('#img_txt_card_hearder').text('Minh chứng bằng');
        }
        if (loaimc == 4) {
            $('#img_txt_card_hearder').text('Minh chứng căn cước công dân');
        }
        if (loaimc == 5) {
            $('#img_txt_card_hearder').text('Minh chứng giấy tờ khác');
        }
        var lastChar = url.substr(url.length - 4); // => kiểm tra file pdf hoặc img

        if (lastChar.toLowerCase() != ".pdf") {

            $('#pdf_view').height('0px');
            $('#pdf_view').css('display', 'none');
            $("#pdf_view").attr("src", "");
            $("#pdf_view").hide();

            $("#img_view").attr("src", url);
            $("#img_view").show();
        }
        if (lastChar.toLowerCase() === ".pdf") {
            $("#img_view").hide();
            $("#img_view").attr("src", "");

            $('#pdf_view').height('500px');
            $('#pdf_view').css('display', 'inline');
            $("#pdf_view").attr("src", url);
            $("#pdf_view").show();
        }
        $('#div_view_img').show();
    }

    $(document).ready(function () {
        $('#bt_close_div_view_img').click(function () {
            reset_div_view_img();
        });

    });
    function reset_div_view_img() {
        $('#img_txt_card_hearder').text('Hình ảnh minh chứng');
        $('#pdf_view').height('0px');
        $('#pdf_view').css('display', 'none');
        $("#pdf_view").attr("src", "");
        $("#pdf_view").hide();

        $("#img_view").attr("src", "");
        $('#img_view').hide();
        $('#div_view_img').hide();
    }
</script>
